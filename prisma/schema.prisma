generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// 1. USUARIOS Y AUTENTICACIÓN
// ============================================

model Usuario {
  id                  Int       @id @default(autoincrement())
  cedula              String    @unique @db.VarChar(15)
  nombres             String    @db.VarChar(191)
  apellidos           String    @db.VarChar(191)
  correoInstitucional String    @unique @map("correo_institucional") @db.VarChar(191)
  rol                 Rol       @default(ESTUDIANTE)
  createdAt           DateTime  @default(now()) @map("created_at") @db.DateTime(3)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.DateTime(3)

  // Relaciones
  auth                Auth?
  propuestas          Propuesta[]
  comentarios         Comentario[]
  notificaciones      Notificacion[]
  comites             Comite[]
  prerequisitos       EstudiantePrerequisito[]
  estudiantePerfil    EstudiantePerfil?

  @@map("usuarios")
}

model Auth {
  id        Int     @id @default(autoincrement())
  username  String  @unique @db.VarChar(191)
  password  String  @db.VarChar(191)
  usuarioId Int     @unique @map("usuario_id")
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  @@map("auth")
}

enum Rol {
  ESTUDIANTE
  TUTOR
  DIRECTOR
  COORDINADOR
  COMITE
  DOCENTE_INTEGRACION
}

// ============================================
// 2. ÁREAS DE CONOCIMIENTO (NUEVO)
// ============================================

model AreaConocimiento {
  id          Int         @id @default(autoincrement())
  codigo      String      @unique @db.VarChar(50)
  nombre      String      @db.VarChar(191)
  descripcion String?     @db.Text
  propuestas  Propuesta[]

  @@map("areas_conocimiento")
}

// ============================================
// 3. PROPUESTAS
// ============================================

model Propuesta {
  id                   Int       @id @default(autoincrement())
  titulo               String    @db.VarChar(191)
  objetivos            String    @db.Text
  problematica         String?   @db.Text
  areaConocimientoId   Int       @map("area_conocimiento_id")
  alcance              String?   @db.VarChar(191)
  archivoUrl           String?   @map("archivo_url") @db.VarChar(191)
  fechaPublicacion     DateTime  @default(now()) @map("fecha_publicacion") @db.DateTime(3)
  estado               EstadoPropuesta @default(PENDIENTE)
  fkEstudiante         Int       @map("fk_estudiante")
  fechaDefensa         DateTime? @map("fecha_defensa") @db.DateTime(3)
  resultadoDefensa     ResultadoDefensa? @default(PENDIENTE) @map("resultado_defensa")

  // Relaciones
  areaConocimiento     AreaConocimiento @relation(fields: [areaConocimientoId], references: [id])
  estudiante           Usuario   @relation(fields: [fkEstudiante], references: [id])
  trabajosTitulacion   TrabajoTitulacion[]
  actividades          Actividad[]
  comites              Comite[]
  entregablesFinales   EntregableFinal[]

  @@map("propuestas")
}

enum EstadoPropuesta {
  PENDIENTE
  APROBADA
  APROBADA_CON_COMENTARIOS
  RECHAZADA
}

enum ResultadoDefensa {
  APROBADO
  REPROBADO
  PENDIENTE
}

// ============================================
// 4. TRABAJO DE TITULACIÓN
// ============================================

model TrabajoTitulacion {
  propuestasId Int @map("propuestas_id")
  fkTutorId    Int @map("fk_tutor_id")

  propuesta    Propuesta @relation(fields: [propuestasId], references: [id])

  @@id([propuestasId, fkTutorId])
  @@map("trabajo_titulacion")
}

// ============================================
// 5. ACTIVIDADES (ACTUALIZADO)
// ============================================

model Actividad {
  id          Int     @id @default(autoincrement())
  nombre      String  @db.VarChar(191)
  descripcion String? @db.Text
  propuestaId Int     @map("propuesta_id")
  tipo        TipoActividad @default(DOCENCIA)

  // Relaciones
  propuesta   Propuesta  @relation(fields: [propuestaId], references: [id], onDelete: Restrict)
  evidencias  Evidencia[]

  @@map("actividades")
}

enum TipoActividad {
  DOCENCIA
  TUTORIA
}

// ============================================
// 6. EVIDENCIAS (ACTUALIZADO)
// ============================================

model Evidencia {
  id           Int       @id @default(autoincrement())
  semana       Int
  contenido    String    @db.Text
  archivoUrl   String?   @map("archivo_url") @db.VarChar(191)
  fechaEntrega DateTime  @default(now()) @map("fecha_entrega") @db.DateTime(3)
  estado       EstadoEvidencia @default(ENTREGADO)
  calificacion Decimal?  @db.Decimal(4, 2)
  actividadId  Int       @map("actividad_id")

  // Relaciones
  actividad    Actividad   @relation(fields: [actividadId], references: [id], onDelete: Restrict)
  comentarios  Comentario[]

  @@map("evidencia")
}

enum EstadoEvidencia {
  ENTREGADO
  NO_ENTREGADO
}

// ============================================
// 7. COMENTARIOS (ACTUALIZADO)
// ============================================

model Comentario {
  id          Int     @id @default(autoincrement())
  evidenciaId Int     @map("evidencia_id")
  usuarioId   Int     @map("usuario_id")
  descripcion String? @db.Text

  // Relaciones
  evidencia   Evidencia @relation(fields: [evidenciaId], references: [id], onDelete: Restrict)
  usuario     Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Restrict)

  @@map("comentarios")
}

// ============================================
// 8. PRERREQUISITOS (REFACTORIZADO)
// ============================================

model CatalogoPrerequisito {
  id          Int      @id @default(autoincrement())
  nombre      String   @db.VarChar(191)
  descripcion String?  @db.Text
  orden       Int      @default(1)
  activo      Boolean  @default(true)

  // Relaciones
  estudiantePrerequisitos EstudiantePrerequisito[]

  @@map("catalogo_prerequisitos")
}

model EstudiantePrerequisito {
  id                 Int       @id @default(autoincrement())
  prerequisitoId     Int       @map("prerequisito_id")
  cumplido           Boolean   @default(false)
  archivoUrl         String?   @map("archivo_url") @db.VarChar(191)
  fechaCumplimiento  DateTime? @map("fecha_cumplimiento") @db.DateTime(3)
  fkEstudiante       Int       @map("fk_estudiante")

  // Relaciones
  prerequisito       CatalogoPrerequisito @relation(fields: [prerequisitoId], references: [id], onDelete: Restrict)
  estudiante         Usuario              @relation(fields: [fkEstudiante], references: [id], onDelete: Restrict)

  @@unique([fkEstudiante, prerequisitoId])
  @@map("estudiante_prerequisitos")
}

// ============================================
// 9. NOTIFICACIONES (ACTUALIZADO)
// ============================================

model Notificacion {
  id            Int      @id @default(autoincrement())
  mensaje       String   @db.Text
  leido         Boolean  @default(false)
  fechaCreacion DateTime @default(now()) @map("fecha_creacion") @db.DateTime(3)
  usuarioId     Int      @map("usuario_id")

  // Relaciones
  usuario       Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Restrict)

  @@map("notificaciones")
}

// ============================================
// 10. ENTREGABLES FINALES
// ============================================

model EntregableFinal {
  id           Int      @id @default(autoincrement())
  tipo         TipoEntregable
  urlArchivo   String   @map("url_archivo") @db.VarChar(255)
  fechaSubida  DateTime @default(now()) @map("fecha_subida") @db.DateTime(3)
  propuestasId Int      @map("propuestas_id")

  // Relaciones
  propuesta    Propuesta @relation(fields: [propuestasId], references: [id], onDelete: Restrict)

  @@map("entregables_finales")
}

enum TipoEntregable {
  TESIS
  MANUAL_USUARIO
  REPOSITORIO
  ARTICULO
}

// ============================================
// 11. COMITÉ (ACTUALIZADO)
// ============================================

model Comite {
  usuarioId     Int      @map("usuario_id")
  propuestaId   Int      @map("trabajo_titulacion_propuestas_id")
  rol           RolComite
  calificacion  Decimal? @db.Decimal(4, 2)
  fechaAsignada DateTime? @db.Date @map("fecha_asignada")

  // Relaciones
  usuario       Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Restrict)
  propuesta     Propuesta @relation(fields: [propuestaId], references: [id])

  @@id([usuarioId, propuestaId])
  @@map("comite")
}

enum RolComite {
  JURADO_1   @map("Jurado 1")
  JURADO_2   @map("Jurado 2")
  PRESIDENTE @map("Presidente")
}

// ============================================
// 12. ESTUDIANTE PERFIL
// ============================================

model EstudiantePerfil {
  id              Int     @id @default(autoincrement())
  sexo            String? @db.VarChar(20)
  estadoEscuela   String? @map("estado_escuela") @db.VarChar(50)
  sede            String? @db.VarChar(100)
  escuela         String? @db.VarChar(100)
  codigoMalla     String? @map("codigo_malla") @db.VarChar(50)
  malla           String? @db.VarChar(100)
  periodoLectivo  String? @map("periodo_lectivo") @db.VarChar(100)
  ciudad          String? @db.VarChar(100)
  provincia       String? @db.VarChar(100)
  pais            String? @db.VarChar(100)
  usuarioId       Int     @unique @map("usuario_id")

  // Relaciones
  usuario         Usuario @relation(fields: [usuarioId], references: [id], onDelete: Restrict)

  @@map("estudiantes_perfil")
}

// ============================================
// 13. MCP AUTHENTICATION
// ============================================

model McpAuth {
  id        Int      @id @default(autoincrement())
  email     String   @db.VarChar(191)
  codigo    String   @db.VarChar(6)
  token     String?  @db.VarChar(64)
  createdAt DateTime @default(now()) @map("created_at") @db.DateTime(3)
  expiresAt DateTime @map("expires_at") @db.DateTime(3)

  @@index([email], map: "mcp_auth_email_idx")
  @@index([token], map: "mcp_auth_token_idx")
  @@map("mcp_auth")
}

